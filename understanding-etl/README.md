# Understanding ETL
> [Understanding ETL](https://www.databricks.com/resources/ebook/understanding-etl) 읽고 정리.


## Prologue. 
> AI/ML 뿐만 아니라 데이터 분석 및 웨어하우스를 위한 다양한 데이터 제공을 위해서 무엇보다 가장 근간에 있는 것이 ETL 임은 두말하면 잔소리

### 1. 데이터 수집
> 외부 소스들로 부터 데이터를 가져와서 인하우스 타깃으로 저장하는 행위를 말하는데, 데이터는 시간이 지나면서 컬럼의 추가, 삭제 혹은 새로운 컬럼으로 교체되기도 합니다
> 이러한 다양한 데이터 소스의 변화를 감지하고, 일관성있고 확장성 있는 데이터를 입수 및 제공할 수 있는 방법을 고안하고, 안정적이고 빠른 데이터 접근을 제공이 필요합니다


#### 데이터 수집의 현재와 과거
* **클라우드**로의 이동, **웨어하우스**에서 **데이터 레이크** 그리고 **레이크하우스**로의 변화 그리고 **스트리밍 기술의 민주화** 등의 패러다임의 변화가 일어나며
  * 데이터 웨어하우스: BI를 위해 데이터 ETL 등의 과정을 통해 구조화 해서 저장하고, 복잡한 쿼리를 빠르게 실행하고 조회하기 위한 시스템
  * 데이터 레이크: 다양한 유형(정형, 비정형)의 원시 데이터를 통합하여 저장 및 처리할 수 있는 분산환경의 대용량 데이터 저장/처리/분석 시스템
  * 레이크하우스: 데이터 레이크의 유연성과 웨어하우스의 관리 및 성능을 제공하며, 다양한 유형지원, ACID 트랜잭션 지원 저장/처리/분석 시스템
* 과거에 비해 데이터를 수집하고 다루는 데에 있어 쉬워지고 간편해진 것은 사실이지만, 소스에서 타겟으로의 데이터 이동임에는 변함이 없다
* 결국, 대용량 데이터 스테이징을 검토하기 전에 ***해당 데이터가 필요***한지, 추출 혹은 집계를 통해 ***사전에 처리가 가능한지 검토***가 필요하다


#### 데이터 소스와 타겟
* 소스 : 데이터 수집 시에는 반드시 **데이터의 특징**을 잘 이해하고, **어떻게 비지니스 가치를 얻을 수 있는지**에 집중하여 질문해야 한다
  * 이해관계자가 *해당 데이터를 어떤 문제를 해결하기 위해서 사용*하는 지를 알아내어야만 문제뒤에 숨어있는 진짜 문제를 파악할 수 있다
  * *어떤 빈도(배치, 스트리밍)로 수집이 필요한 지*는, 분석시점에 필요한 데이터의 범위가 Bounded 인지 Unbounded 인지 파악할 수 있어야 한다
    * Bounded 의 경우라면 최소 수집 빈도를 고려해야하며, 빈도와 데이터의 크기에 따라 비용과 리소스 사용이 증가함을 이해해야 한다
    * Unbounded 의 경우라면 최대 지연 가능 시간과, Back-fill 등에 대한 SLA 수준까지 검토해야만 한다
    * 특히 빈도의 선택에 있어서 가장 중요한 것은 ***비즈니스 가치를 충분히 얻어낼 수 있는 "적절한 시간(right-time)"을 파악***하는 것이다
  * 대상 *데이터의 크기가 하루에 증가하는 양과 단위 시간에 발생하는 최대 크기* 등을 이해해야만 입수 솔루션의 확장성, 안정성을 결정할 수 있다
  * *어떤 포맷으로 저장* 되어 있는지 그리고 대상 *데이터의 품질(비어있는 값 등)은 어떤지*를 파악해야만 후처리 혹은 인리치를 고려할 수 있다
* 타겟 : 저장 시에는 이해관계자에 집중할 필요가 있는데 BI, 분석, AI/ML 애플리케이션 등 다양한 목적과 용도에 따라 저장되어야 하기 때문이다
  * 스테이징 : 데이터 레이크 적재 스타일으로 블록/오브젝트 스토리지에 저장한 후에 가공 및 적재하는 방식을 말합니다
    * 특히, 시간여행과 ACID 한 트랜잭션 지원 등을 포장하는 Delta, Iceberg, Hudi 와 같은 저장 프레임워크를 활용하는 것을 추천하며
    * 이러한 포맷을 활용하여 세 가지 품질의 단계의 ***메달리온 아키텍처를 유지함으로써 스키마 히스토리, 에볼루션 및 데이터 백필을 보장***합니다
  * CDC : 소스 데이터베이스의 변경 사항을 캡처하여 다운스트림 시스템에 지속적으로 업데이트 하는 방식을 말합니다
    * 변경된 데이터만 전송하기에 속도와 리소스 사용을 최소화 할 수 있으며, 실시간 분석 및 데이터 웨어하우스에 적합합니다
    * 최근, SCD (Slowly Changing Dimension) 지원을 위한 Databricks 의 DLT(Delta Live Table)을 활용할 수 있습니다
* 소스와 타겟 체크리스트
  * Who will we collaborate with? 사용자는 누구인가요?
  * How will the data be used? ***어떤 비즈니스 가치를 달성하기 위한 데이터***인가요?
  * Are there multiple sources or destinations? 다수의 소스와 타겟이 있나요?
  * What's the format? 데이터 포맷?
  * What's the frequency? ***배치(bounded) 혹은 스트리밍(unbounded)***?
  * What's the volume? ***데이터 크기***?
  * What processing is required? 데이터의 ***전처리, 후처리 혹은 인리치(enrich)***이 필요한가?
  * How will the data be stored? 어떤 소스 혹은 타깃으로 저장되며, 어떤 도구를 통해서 수집 저장되는가?


#### 데이터 입수 고려사항
* 프리퀀시: 배치, 마이크로배치, 스트리밍 등의 단계에서 가장 적절한 입수 프리퀀시를 찾는 것이 중요하다
* 볼륨: 데이터 레이턴시, 처리량 그리고 확장성은 높으면 높을 수록 좋지만, 결국 리소스와 비용에 비례하기 때문에 적합한 밸런스가 중요하다
* 형태: 다양한 형태(Structured, Semi-structured, Unstructured)의 데이터는 특성에 따라 비용이 증가하므로 쓸모가 있는지 판단해야 한다
* 포맷: 가장 친숙하고, 많이 사용하는 포맷을 사용해야 사용성, 호환성을 보장 받을 수 있고 다양한 라이브러리와 커뮤니티 지원을 받을 수 있다

#### 솔루션 선택
* Declarative solution: 레거시 혹은 최신 솔루션
  * Legacy: Talend, Pentaho 등은 다양한 커넥터와 안정성을 보장하지만, 최신 데이터 스택(Modern Data Stack) 지원이 늦어 비추천
  * Modern: Fivetran, Stitch, Airbyte 등의 다양한 솔루션과 프레임워크는 MDS 지원하므로 추천
  * Native: 데이터브릭스와 같은 상용 솔루션 지원이 가능하다면 LST 와 같은 네이티브 지원을 통해 CDC 테이블까지 사용 가능함
  * 이러한 솔루션을 통한 접근은 초기비용이 작고, 빠르게 개발이 가능하여 개발 및 유지보수 비용이 줄어들지만 기능확장 및 전환 비용이 아주 크다
* Imperative solution: 인하우스 솔루션
  * Singer(Meltano), Lambda, Apache Beam 등을 통한 개발과 Airflow 등을 통한 운영이 가능하며, 별도의 개발/운영 조직이 필수이다
  * 무엇보다 확장성이 좋아(상대적인 것이지 쉽다는 것이 아님) 복잡하고 어려운 수집도 가능하지만, 별도의 엔지니어 조직이 필요하다
  * 이러한 도구는 당연하게도 모듈화, 단위 테스트, 설계 등의 면에서 확장 가능성과 안정성을 보장할 수 있도록 개발 운영되어야만 한다
  * 상대적으로 레거시 솔루션에 비해 전환비용이 다소 작다고 볼 수 있다
* Hybrid solution: 하이브리드 솔루션
  * 단순 반복적인 데이터는 Fivetran 과 같은 도구를 사용하고, 복잡하고 난이도 있는 데이터는 Airbyte/Meltano 등의 플랫폼을 활용한다

| -                      | Declarative  | Imperative | Hybrid       |
|------------------------|--------------|------------|--------------| 
| Extensibility          | Low/moderate | **High**   | **High**     | 
| Cost to build/maintain | **Low**      | High       | **Moderate** | 
| Lock-in                | High         | **Low**    | **Low**      | 


#### 관계형 데이터베이스 수집 솔루션
* [ChatGPT Says](https://chatgpt.com/share/bf9be9f7-eba8-45be-b3a5-6b36734ed746)
* [Fivetran vs. Stitch](https://airbyte.com/etl-tools/fivetran-vs-stitch)
* [Stitch Vs Fivetran Vs Airbyte](https://apix-drive.com/en/blog/other/stitch-vs-fivetran-vs-airbyte)

#### 데이터 ETL 도구
* [Fivetran](https://www.fivetran.com/)
* [Stitchdata](https://www.stitchdata.com/)
* [Airbyte](https://airbyte.com/)
* [Singer](https://www.singer.io/)
* [Meltano](https://meltano.com/)